# CRM-system

Веб‑CRM система для ведения клиентской базы, сделок и задач с воронкой продаж, заметками, файлами и встроенным диалогом по сделке (email + синхронизация входящих). Проект реализован на Laravel и ориентирован на быстрый старт и дальнейшее расширение.

![CRM-system — аналитика](/assets/crm-screenshot.png)

---

## Что внутри (кратко)

- **Компании**: карточка компании + контакты
- **Контакты**: привязка к компании, email/телефон/должность
- **Сделки**: стадии, сумма/валюта, плановая дата закрытия, назначение на пользователя
- **Воронка продаж**: перенос сделок по стадиям с подтверждением и быстрым обновлением
- **Активности**: звонки/встречи/письма/задачи, статус выполнения
- **Заметки**: заметки по компании/сделке
- **Файлы**: загрузка и привязка вложений к сущностям
- **Диалог по сделке**: исходящие письма, сохранение истории, синхронизация входящих через IMAP
- **Встроенный чат**: общий чат внутри системы
- **Админ‑панель**: пользователи/роли, статистика, безопасный просмотр таблиц и выполнение SELECT‑запросов

---

## Стек

### Backend

- **PHP 8.2+**
- **Laravel 12**
- **Laravel Breeze** (аутентификация, email‑верификация, профиль)
- **spatie/laravel-permission** (пакет для ролей/прав; в проекте дополнительно используется поле `role` + `is_admin`)

### Frontend

- **Blade** (страницы CRM)
- **Tailwind CSS**
- **Vite**
- **Alpine.js** (подключён как зависимость)
- **Fetch API** (JS‑логика страниц: списки, фильтры, модалки, kanban)

### Хранилища/интеграции

- **MySQL / MariaDB** (основная БД)
- **SMTP/IMAP** (почтовый диалог)
- **Mailpit** (dev‑fallback для локальной отправки в окружении `local`, если SMTP недоступен)

---

## Основные модули CRM

### 1) Пользователи и доступы

- Авторизация/регистрация и подтверждение email — из **Laravel Breeze**.
- Роли в проекте представлены как:
  - `users.is_admin` (жёсткий признак администратора)
  - `users.role` (`employee` / `manager` / `admin`)
- Для админ‑раздела включён middleware `EnsureUserIsAdmin`.
- Ограничения по сделкам реализованы прямо в контроллере:
  - **employee** видит/меняет только свои сделки (кроме режима отчётов)
  - **manager / admin** видят все сделки и могут назначать исполнителя

### 2) Сущности и связи

Сущности лежат в `app/Models` и описаны через Eloquent:

- `Company` ⇄ `Contact` (контакты привязаны к компании)
- `Deal` привязан к `Company`, `Contact`, `Stage`, `User`
- `Activity` может быть привязана к сделке/контакту и иметь исполнителя
- `Note` хранится как polymorphic‑связь (заметки к разным сущностям)
- `FileAttachment` — вложения к сущностям

Миграции и структура БД: `database/migrations`.

### 3) Сделки (список, фильтры, сортировки, назначение)

- API: `routes/api.php` → `Route::apiResource('deals', DealController::class)`
- В `DealController@index` есть:
  - поиск по названию `q`
  - фильтры (`company_id`, `contact_id`, `stage_id`, `user_id`, диапазон суммы)
  - сортировки (по полям и через join по `company/stage/user`)
  - пагинация
- В `store/update` — валидация и правила назначения исполнителя в зависимости от роли.

### 4) Воронка продаж (Kanban)

- Страница: `/kanban` → `resources/views/crm/kanban.blade.php`
- Идея реализации:
  - грузим стадии `/api/stages`
  - грузим сделки `/api/deals?per_page=1000`
  - отрисовываем колонки, в карточке сделки показываем сумму и компанию
  - перенос между стадиями происходит через `PUT /api/deals/{id}` (обновление `stage_id`)

### 5) Диалог по сделке (Email + IMAP sync)

- API:
  - `GET /api/emails` — получить письма, связанные с сущностью (`Deal/Company/Contact`)
  - `POST /api/emails/send` — отправить письмо, сохранить его в БД и привязать к сущности
  - `POST /api/emails/sync` — синхронизировать входящие через IMAP
- Сохранение тредов:
  - генерируется `Message-ID`
  - при продолжении переписки используется `In-Reply-To`/`References`
  - `thread_id` позволяет склеивать цепочки в одном диалоге

### 6) Импорт и генерация тестовых данных

- Страница: `/import`
- Импорт CSV (компании/контакты/сделки) — `ImportController`
- Генератор тестовых данных — `GenerateDataController`

### 7) Админ‑панель

- `/admin`:
  - статистика (кол-во пользователей/компаний/сделок, сумма сделок, выигранные)
  - управление пользователями (создание/редактирование/удаление)
  - просмотр таблиц БД и выполнение **ограниченных** запросов (блокируются DROP/TRUNCATE/DELETE/ALTER и т.п.)

---

## Структура проекта

- `routes/web.php` — страницы CRM + админ‑панель
- `routes/api.php` — JSON API для сущностей
- `app/Http/Controllers/*` — CRUD/логика
- `app/Models/*` — модели и связи
- `resources/views/crm/*` — интерфейс CRM (Blade + JS)
- `database/migrations/*` — схема БД

---

![](/assets/01.png)
![](/assets/02.png)
![](/assets/03.png)
![](/assets/04.png)
![](/assets/05.png)
![](/assets/06.png)
![](/assets/07.png)
![](/assets/08.png)
![](/assets/09.png)
![](/assets/10.png)
![](/assets/11.png)
![](/assets/12.png)
![](/assets/13.png)
![](/assets/14.png)

## Версия

- **1.0.1** — добавлена мобильная версия интерфейса
